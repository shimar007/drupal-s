<?php

/**
 * @file
 * Displays Google AdSense ads on Drupal pages.
 *
 * This is the core module of the AdSense package, with the Drupal hooks
 * and other administrative functions.
 */

use Drupal\Core\Routing\RouteMatchInterface;

use Drupal\adsense\AdsenseAdBase;
use Drupal\adsense\ContentAdBase;
use Drupal\adsense\PublisherId;

// Ad types, link or ad.
define('ADSENSE_TYPE_LINK', 1);
define('ADSENSE_TYPE_AD', 2);
define('ADSENSE_TYPE_SEARCH', 3);
define('ADSENSE_TYPE_MATCHED', 4);

/**
 * Implements hook_page_attachments().
 */
function adsense_page_attachments(array &$attachments) {
  $config = \Drupal::config('adsense.settings');
  if ($config->get('adsense_managed_page_level_ads_enabled')) {
    /* @var \Drupal\system\Plugin\Condition\RequestPath $condition */
    $condition = \Drupal::getContainer()->get('plugin.manager.condition')->createInstance('request_path');
    $visibility = $config->get('adsense_access_pages');
    if ($visibility) {
      $condition->setConfiguration($visibility);
    }

    if ($visibility['negate'] xor !$condition->evaluate()) {
      $attachments['#attached']['html_head'][] = [
        [
          '#tag' => '',
          '#theme' => 'adsense_comment',
          '#comment' => 'adsense page-level ads: page not in match list',
        ],
        'adsense_unmatched_page',
      ];
    }
    elseif (AdsenseAdBase::isDisabled()) {
      $attachments['#attached']['html_head'][] = [
        [
          '#tag' => '',
          '#theme' => 'adsense_comment',
          '#comment' => 'adsense page-level ads: ads disabled',
        ],
        'adsense_ads_disabled',
      ];
    }
    else {
      $client = PublisherId::get();
      \Drupal::moduleHandler()->alter('adsense', $client);
      $attachments['#attached']['html_head'][] = [
        [
          '#tag' => 'script',
          '#theme' => 'adsense_managed_page_level',
          '#client' => $client,
        ],
        'adsense_managed_page_level',
      ];
    }
  }
}

/**
 * Implements hook_theme().
 */
function adsense_theme() {
  return [
    'adsense_ad' => [
      'variables' => [
        'content' => '',
        'width' => '',
        'height' => '',
        'format' => '',
        'classes' => [],
      ],
    ],
    'adsense_comment' => [
      'variables' => [
        'comment' => '',
      ],
    ],
    'adsense_cse_branding' => [
      'variables' => [
        'class' => '',
        'bg_color' => '',
        'color' => '',
        'results_path' => '',
        'client' => '',
        'slot' => '',
        'forid' => '',
        'encoding' => '',
        'qsize' => '',
        'search' => '',
        'custom_search' => '',
      ],
    ],
    'adsense_cse_results' => [
      'variables' => [
        'width' => '',
        'country' => '',
        'script' => '',
      ],
    ],
    'adsense_cse_watermark' => [
      'variables' => [
        'language' => '',
        'results_path' => '',
        'client' => '',
        'slot' => '',
        'forid' => '',
        'encoding' => '',
        'qsize' => '',
        'search' => '',
        'script' => '',
      ],
    ],
    'adsense_managed_async' => [
      'variables' => [
        'format' => '',
        'width' => '',
        'height' => '',
        'client' => '',
        'slot' => '',
      ],
    ],
    'adsense_managed_page_level' => [
      'variables' => [
        'client' => '',
      ],
    ],
    'adsense_managed_responsive' => [
      'variables' => [
        'format' => '',
        'client' => '',
        'slot' => '',
        'shape' => '',
      ],
    ],
    'adsense_managed_sync' => [
      'variables' => [
        'format' => '',
        'width' => '',
        'height' => '',
        'client' => '',
        'slot' => '',
        'secret' => '',
      ],
    ],
  ];
}

/**
 * Implements template_preprocess_HOOK().
 */
function template_preprocess_adsense_ad(&$variables) {
  if ((!empty($variables['format'])) && ((empty($variables['width'])) || (empty($variables['height'])))) {
    list($variables['width'], $variables['height']) = ContentAdBase::dimensions($variables['format']);
  }

  if (empty($variables['content'])) {
    $variables['content'] = '<-- empty ad content -->';
  }

  if ((!empty($variables['width'])) && (!empty($variables['height']))) {
    $variables['style'] = "width:${variables['width']}px;height:${variables['height']}px;";
  }

  $variables['classes'] = implode(' ', $variables['classes']);
}

/**
 * Implements hook_help().
 */
function adsense_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.adsense':
      module_load_include('inc', 'adsense', 'help/adsense.help');
      return adsense_help_text();
  }
  return '';
}

/**
 * Generates the Google AdSense Ad.
 *
 * @param array $args
 *   An array of arguments (format, group, channel or slot).
 *   A valid format must always be provided. If a slot is provided, the ad is
 *   generated by the new format modules, if not then the 'old' format modules
 *   are attempted.
 *
 * @return array|string
 *   Render array with ad code.
 */
function adsense_display(array $args) {
  if (!is_array($args)) {
    // 'old' method of calling this function is not supported in version >= 8.x
    // adsense_display($format, $group, $channel, $slot, $referral, $cpa).
    return '<!--adsense: old adsense_display call syntax not supported -->';
  }

  $ad = AdsenseAdBase::createAd($args);

  if (isset($ad)) {
    return $ad->display();
  }
  else {
    return '<!-- adsense: no ad generated. -->';
  }
}

/**
 * Implements hook_preprocess_block().
 */
function adsense_preprocess_block(&$variables) {
  // Remove adsense from the block id and classes to bypass adblock rules.
  if (($variables['plugin_id'] == 'adsense_managed_ad_block') &&
      \Drupal::config('adsense.settings')->get('adsense_unblock_ads')) {
    $variables['attributes']['id'] = str_replace('adsense', '', $variables['attributes']['id']);
    $variables['configuration']['provider'] = str_replace('adsense', '', $variables['configuration']['provider']);
  }
}
